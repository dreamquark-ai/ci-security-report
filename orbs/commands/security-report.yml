description: Create and publish security report as a PR comment
parameters:
    image:
        type: string
    base-tag:
        type: string
        default: latest
    new-tag:
        type: string
        default: security-test
    orga:
        type: string
        default: 'dreamquark-ai'
    repo:
        type: string
    pr-nb:
        type: string
    topic:
        type: string
        default: image

steps:
    - run:
        name: "Run Trivy security report on the base image"
        command: |
            trivy -q -f json -o reports/report-base.json << parameters.image >>:<< parameters.base-tag >>
    - run:
        name: "Run Trivy security report on the new image"
        command: | 
            trivy -q -f json -o reports/report-new.json << parameters.image >>:<< parameters.new-tag >>
    - run:
        name: "Compare the report and publish the differential comment as a PR comment"
        command: |
            ./main.sh --image << parameters.image >> --base-tag << parameters.base-tag >> --new-tag << parameters.new-tag >>
            --pull-request << parameters.pr-nb >> --topic << parameters.topic >> --repo << parameters.repo >> --orga << parameters.orga >>

./main.sh --image alpine --base-tag 3.12 --new-tag 3.12 --pull-request ${CIRCLE_PULL_REQUEST##*/} --topic alpine --repo brain-engine --orga dreamquark-ai